<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    <link rel="manifest" href="/static/manifest.webmanifest">
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="stylesheet" href="/static/pygments.css" />
    <link rel="canonical" href="https://kalnytskyi.com/posts/on-tmux-osc52-support/" />
    <link rel="alternate" type="application/atom+xml" href="/feed.xml" title="Ihor Kalnytskyi" />

    <meta name="author" content="Ihor Kalnytskyi" />
    <meta name="description" content="OSC-52, NeoVim and surprising behavior when running under tmux." />

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@ikalnytskyi" />
    <meta name="twitter:title" content="On tmux OSC-52 support" />
    <meta name="twitter:description" content="OSC-52, NeoVim and surprising behavior when running under tmux." />

    <meta property="og:title" content="On tmux OSC-52 support" />
    <meta property="og:description" content="OSC-52, NeoVim and surprising behavior when running under tmux." />
    <meta property="og:url" content="https://kalnytskyi.com/posts/on-tmux-osc52-support/" />
    <meta property="og:site_name" content="Ihor Kalnytskyi" />
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="2023-11-14T00:00:00+00:00" />
    <meta property="article:modified_time" content="2023-11-14T21:19:30.215364+00:00" />
    <meta property="article:author" content="Ihor Kalnytskyi" />

    <title>On tmux OSC-52 support</title>
</head>
<body>
  <div class="banner"><a rel="nofollow" href="https://savelife.in.ua/en/donate-en/">Save lives in Ukraine</a> →</div>

  <aside>
    <img class="about-pic" src="/about/me.jpg" alt="photo" />
    <span class="about-txt"><a href="/about/" rel="me">Ihor Kalnytskyi</a>'s<br />
thoughts & writings</span>

    <div class="nav-wrapper">
    <nav>
      <span><a href="/">Archives</a></span>
      <span><a href="/talks/">Talks</a></span>
      <span><a href="/feed.xml">Feed</a></span>
    </nav>
    </div>
  </aside>

  <main>
    <article>
      <header>
        <time datetime="2023-11-14T00:00:00+00:00">November 14, 2023</time>
        <h1>On tmux OSC-52 support</h1>
      </header>

      <p>Several days ago, OSC-52 support was <a href="https://github.com/neovim/neovim/pull/25872">merged</a> into NeoVim, and this sparkled
my interest. It was just natural, given that both NeoVim and OSC-52 are
essential part of my daily workflow.</p>
<p>For those unfamiliar, OSC stands for <em>Operating System Command</em>, and it's a set
of <a href="https://en.wikipedia.org/wiki/ANSI_escape_code">escape sequences</a> originally <a href="https://invisible-island.net/xterm/ctlseqs/ctlseqs.html#h3-Operating-System-Commands">defined by Xterm</a>, but now adopted by
various modern terminal emulators<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>. OSC-52, in particular, is an escape
sequence that allows <em>copying to</em> and <em>pasting from</em> the system clipboard.</p>
<p>I have a few development environments running in virtual machines or
systemd-nspawn containers, and I typically SSH into them and run NeoVim from
within. Needless to say that a NeoVim instance running inside container has no
access to the system clipboard<sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>, and this is where OSC-52 comes to the
rescue!</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="326pt" height="138pt"
 viewBox="0.00 0.00 326.00 138.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 134)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-134 322,-134 322,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_Host</title>
<polygon fill="none" stroke="#2e3440" stroke-dasharray="5,2" points="8,-8 8,-122 310,-122 310,-8 8,-8"/>
<text text-anchor="middle" x="159" y="-106.8" font-family="Times,serif" font-size="14.00">Host</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_VM</title>
<polygon fill="none" stroke="#2e3440" stroke-dasharray="5,2" points="212,-16 212,-91 302,-91 302,-16 212,-16"/>
<text text-anchor="middle" x="257" y="-75.8" font-family="Times,serif" font-size="14.00">VM</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_Container1</title>
<polygon fill="none" stroke="#2e3440" stroke-dasharray="5,2" points="114,-16 114,-91 204,-91 204,-16 114,-16"/>
<text text-anchor="middle" x="159" y="-75.8" font-family="Times,serif" font-size="14.00">Container</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_Container2</title>
<polygon fill="none" stroke="#2e3440" stroke-dasharray="5,2" points="16,-16 16,-91 106,-91 106,-16 16,-16"/>
<text text-anchor="middle" x="61" y="-75.8" font-family="Times,serif" font-size="14.00">Container</text>
</g>
<!-- neovim1 -->
<g id="node1" class="node">
<title>neovim1</title>
<polygon fill="none" stroke="#2e3440" points="293.5,-60 220.5,-60 220.5,-24 293.5,-24 293.5,-60"/>
<text text-anchor="middle" x="257" y="-38.3" font-family="Times,serif" font-size="14.00">NeoVim</text>
</g>
<!-- neovim2 -->
<g id="node2" class="node">
<title>neovim2</title>
<polygon fill="none" stroke="#2e3440" points="195.5,-60 122.5,-60 122.5,-24 195.5,-24 195.5,-60"/>
<text text-anchor="middle" x="159" y="-38.3" font-family="Times,serif" font-size="14.00">NeoVim</text>
</g>
<!-- neovim3 -->
<g id="node3" class="node">
<title>neovim3</title>
<polygon fill="none" stroke="#2e3440" points="97.5,-60 24.5,-60 24.5,-24 97.5,-24 97.5,-60"/>
<text text-anchor="middle" x="61" y="-38.3" font-family="Times,serif" font-size="14.00">NeoVim</text>
</g>
</g>
</svg>
<p>If your terminal emulator supports it, NeoVim's built-in OSC-52 clipboard
provider just works! Here's the thing though: if you're a blessed user of tmux,
things might not go the way you expect them to go. I quickly noticed a peculiar
behavior that I initially mistook for a bug: OSC-52 pasting didn't paste the
content of the system clipboard, but rather the content of tmux top buffer.</p>
<p>Despite being called a multiplexer, tmux acts as a terminal emulator, which
means it implements many OSC sequences itself, including OSC-52. When it comes
to copying, tmux saves captured text to its buffer and passes the escape
sequence up to the parent terminal to set the system clipboard. Pasting, on the
other hand, always retrieves a content from a tmux buffer, forms a response and
passes it up to the parent terminal for pasting. The content of the buffer may
be a text you previously copied (and hence implicitly saved) or a text you
explicitly saved to a buffer.</p>
<p>What does this mean practically? It means that a text you copy in NeoVim can be
pasted in a browser. However, a text that you copied in a browser cannot be
pasted to NeoVim. Lame, huh?</p>
<p>Unfortunately, this is intentional behavior because tmux supports multiple
clients that may be attached from multiple hosts<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>. It's a no-brainer with
copying: we just send a text we want to copy to all clients and let their
terminal emulators to set the system clipboard. But what should we do with
pasting? What attached client should be used as a clipboard source?</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="266pt" height="174pt"
 viewBox="0.00 0.00 266.00 174.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 170)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-170 262,-170 262,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_Host1</title>
<polygon fill="none" stroke="#2e3440" stroke-dasharray="5,2" points="8,-8 8,-158 128,-158 128,-8 8,-8"/>
<text text-anchor="middle" x="68" y="-142.8" font-family="Times,serif" font-size="14.00">Host A</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_Host2</title>
<polygon fill="none" stroke="#2e3440" stroke-dasharray="5,2" points="136,-8 136,-83 250,-83 250,-8 136,-8"/>
<text text-anchor="middle" x="193" y="-67.8" font-family="Times,serif" font-size="14.00">Host B</text>
</g>
<!-- tmux_server -->
<g id="node1" class="node">
<title>tmux_server</title>
<polygon fill="none" stroke="#2e3440" points="120,-127 16,-127 16,-91 120,-91 120,-127"/>
<text text-anchor="middle" x="68" y="-105.3" font-family="Times,serif" font-size="14.00">tmux server</text>
</g>
<!-- tmux_client1 -->
<g id="node2" class="node">
<title>tmux_client1</title>
<polygon fill="none" stroke="#2e3440" points="117,-52 19,-52 19,-16 117,-16 117,-52"/>
<text text-anchor="middle" x="68" y="-30.3" font-family="Times,serif" font-size="14.00">tmux client</text>
</g>
<!-- tmux_server&#45;&gt;tmux_client1 -->
<g id="edge1" class="edge">
<title>tmux_server&#45;&gt;tmux_client1</title>
<path fill="none" stroke="black" d="M68,-80.49C68,-70.98 68,-60.61 68,-52.18"/>
<polygon fill="black" stroke="black" points="64.5,-80.7 68,-90.7 71.5,-80.7 64.5,-80.7"/>
</g>
<!-- tmux_client2 -->
<g id="node3" class="node">
<title>tmux_client2</title>
<polygon fill="none" stroke="#2e3440" points="242,-52 144,-52 144,-16 242,-16 242,-52"/>
<text text-anchor="middle" x="193" y="-30.3" font-family="Times,serif" font-size="14.00">tmux client</text>
</g>
<!-- tmux_server&#45;&gt;tmux_client2 -->
<g id="edge2" class="edge">
<title>tmux_server&#45;&gt;tmux_client2</title>
<path fill="none" stroke="black" d="M125.28,-86.62C127.58,-85.45 129.83,-84.24 132,-83 147.21,-74.3 162.7,-62.06 174.27,-52.12"/>
<polygon fill="black" stroke="black" points="123.76,-83.47 116.25,-90.94 126.78,-89.78 123.76,-83.47"/>
</g>
</g>
</svg>
<p>Fortunately, tmux gives us a command, <code>refresh-client -l</code>, that can be executed
by any client to sync the content of the system clipboard to a tmux buffer,
that can subsequently be used to paste the content via OSC-52.</p>
<p>I decided to share this information, as I spent at least an hour running tmux
under gdb, chasing a ghost that doesn't exist. I don't want anyone to repeat my
experience.</p>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>OSC-52 is at least supported by alacritty, contour, foot, hterm, iterm2,
kitty, rxvt, st, tmux, wezterm, windows terminal and zelij. <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>In my case, VMs and containers have no access to the wayland socket, and
I don't want them to. <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a href="https://github.com/tmux/tmux/issues/1477#issuecomment-421344891">https://github.com/tmux/tmux/issues/1477#issuecomment-421344891</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

    </article>
  </main>
</body>